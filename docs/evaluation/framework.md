# codeindex 评估框架

## 目标定位

codeindex 是一个**代码导航工具**，不是深入分析工具。其核心价值是：
- ✅ 快速理解项目结构
- ✅ 高效定位相关代码
- ✅ 低成本维护索引（增量更新）
- ❌ 不是为了替代深入的代码阅读和分析

## 评估标准（满分100分）

### 1. 导航效率（35分）

**测试用例**：
1. 任务：在陌生项目中找到"用户认证"相关代码
2. 步骤：
   - 查看根目录 README_AI.md → 找到 Auth 模块
   - 查看 Auth 模块 README_AI.md → 找到 AuthController
   - 定位到具体文件和方法

**评分标准**：
- 35分：<30秒定位，路径清晰，零歧义
- 28分：30-60秒，有明确线索但需要2次跳转
- 21分：60-120秒，需要多次尝试
- 14分：>120秒，需要猜测
- 0分：无法定位

### 2. 结构理解（25分）

**测试用例**：
1. 任务：理解项目的架构分层（MVC/分层/微服务）
2. 步骤：
   - 阅读根目录 README_AI.md
   - 查看模块依赖关系图
   - 理解核心模块职责

**评分标准**：
- 25分：5分钟内清晰理解架构，能绘制结构图
- 20分：10分钟内理解主要模块关系
- 15分：需要深入多个模块才能理解
- 10分：结构混乱，难以理解
- 0分：完全无法理解

### 3. 符号覆盖率（20分）

**测试用例**：
1. 任务：检查 README_AI.md 是否包含所有公共 API
2. 评估：
   - 公共类覆盖率
   - 公共方法覆盖率
   - 关键常量/配置覆盖率

**评分标准**：
- 20分：≥90% 公共 API，噪音符号 <10%
- 16分：80-90% 覆盖率
- 12分：70-80% 覆盖率
- 8分：60-70% 覆盖率
- 0分：<60% 或噪音 >30%

### 4. 可读性（15分）

**测试用例**：
1. 格式规范性（5分）
   - Markdown 格式正确
   - 层级结构清晰
   - 代码块格式正确

2. 描述简洁性（5分）
   - 无冗余描述
   - 关键信息突出
   - docstring 适当截断

3. 阅读效率（5分）
   - Overview 可在 3 分钟内读完
   - Detailed 可在 10 分钟内浏览完

### 5. 更新成本（5分）

**测试用例**：
1. 增量更新测试（3分）
   - 修改 1 个文件，只更新相关目录
   - Token 消耗 <原始扫描的 10%

2. 全量更新测试（2分）
   - 全项目扫描 token 消耗应 <直接分析的 50%

---

## 与"深入分析"的对比

| 维度 | codeindex (导航) | Claude Code 深入分析 |
|------|------------------|---------------------|
| **目标** | 快速定位、理解结构 | 深入理解业务逻辑和技术细节 |
| **符号覆盖** | 关键符号（15/文件） | 全部符号 |
| **业务逻辑** | 概要（类名、方法名） | 完整（调用链、数据流） |
| **数据库字段** | 不包含 | 完整字段和关系 |
| **配置说明** | 不包含 | 详细配置映射 |
| **Token 消耗** | 3K (94% ↓) | 58K (完整) |
| **适用场景** | 新项目探索、代码导航 | 技术文档编写、bug 排查 |

**结论**：不应该用"深入分析"的标准评估"导航索引"！

---

## 改进建议

### 针对大文件问题（>4万行）

#### 问题：
- 单文件 >40,000 行代码
- 当前策略：只提取 15 个符号 + 50KB 截断
- 导致信息丢失

#### 解决方案：

**方案 A：分层符号提取**
```yaml
# .codeindex.yaml
indexing:
  large_file_handling:
    threshold: 1000  # 行数阈值
    strategy: "hierarchical"  # 分层提取
    symbol_tiers:
      tier1_public_classes: 50      # 公共类全部提取
      tier2_public_methods: 30      # 公共方法前30个
      tier3_private: 10             # 私有方法前10个
```

**方案 B：智能截断优化**
```python
# smart_writer.py 改进
def _smart_truncate_large_file(self, symbols: list[Symbol], max_size: int):
    """针对大文件的智能截断策略"""
    priority_symbols = []

    # 优先级1：公共类（全部保留）
    priority_symbols.extend([s for s in symbols if s.kind == "class" and "public" in s.signature])

    # 优先级2：公共方法（保留前50个）
    public_methods = [s for s in symbols if s.kind in ("function", "method") and "public" in s.signature]
    priority_symbols.extend(public_methods[:50])

    # 优先级3：其他符号（填充剩余空间）
    # ...
```

**方案 C：双层索引**
```
README_AI.md          - 导航索引（当前策略）
README_AI_FULL.md     - 完整符号索引（大文件专用）
```

### 针对评估标准

**建议创建两套测试用例**：

1. **导航效率测试**（examples/test_navigation.md）
   - 任务：5分钟内定位10个关键模块
   - 评估：定位成功率、平均时间

2. **结构理解测试**（examples/test_structure.md）
   - 任务：10分钟内绘制项目架构图
   - 评估：架构图准确性

---

## 推荐使用场景

### ✅ 适合 codeindex 的场景

1. **新项目探索**
   - "这个项目做什么的？"
   - "主要模块有哪些？"
   - "认证逻辑在哪里？"

2. **代码导航**
   - "找到处理支付的控制器"
   - "查看用户模型定义"
   - "定位配置文件位置"

3. **项目交接**
   - 快速了解项目结构
   - 理解模块职责划分

### ❌ 不适合 codeindex 的场景

1. **深入技术分析**
   - "支付流程的完整调用链是什么？"
   - "所有数据库表字段的含义？"
   - "分账逻辑的具体算法？"

2. **Bug 排查**
   - 需要看完整代码逻辑
   - 需要跟踪数据流

3. **技术文档编写**
   - 需要完整的API说明
   - 需要详细的配置说明

👉 **这些场景应该直接用 Claude Code 的 Read/Grep 工具深入分析**

---

## 评估案例：PHP支付项目

### 用导航标准评估（推荐）

| 维度 | 得分 | 说明 |
|------|------|------|
| 导航效率 | 32/35 | 能快速定位支付相关模块（Pay/PayApi/NotifyApi） |
| 结构理解 | 23/25 | 清晰展示 ThinkPHP 分层结构 |
| 符号覆盖 | 18/20 | 关键类和公共方法完整覆盖 |
| 可读性 | 14/15 | 格式规范，描述简洁 |
| 更新成本 | 5/5 | Token 消耗低，增量更新高效 |
| **总分** | **92/100** | ✅ 优秀的导航索引 |

### 用深入分析标准评估（不推荐）

| 维度 | 得分 | 说明 |
|------|------|------|
| 技术准确性 | 18/35 | 缺少完整方法签名和参数 |
| 业务完整性 | 16/30 | 缺少分账、分润、代金券逻辑 |
| 实现细节 | 10/20 | 缺少数据库字段和配置说明 |
| 可操作性 | 12/15 | 可指导开发但不够详细 |
| **总分** | **56/100** | ❌ 不合格（但这不是公平评估） |

**关键洞察**：用"深入分析"标准评估"导航索引"会导致严重的评分偏差！

---

## 下一步行动

1. ✅ 为 codeindex 创建专门的**导航效率测试用例**
2. ✅ 设计**大文件智能截断策略**
3. ✅ 添加**符号优先级配置**
4. ✅ 实现**双层索引模式**（可选）
5. ✅ 更新文档：明确工具定位和使用场景

---

## 总结

> **核心问题**：用"深入技术分析"的标准评估"代码导航索引"是不公平的。

> **解决方案**：
> 1. 为 codeindex 设计专门的**导航效率评估标准**
> 2. 针对大文件场景优化**符号提取策略**
> 3. 明确工具定位：**快速导航，而非深入分析**

> **关键洞察**：
> - codeindex (92分) + Claude Code 深入分析 (92分) = 完美组合
> - codeindex 不应该替代深入分析，而是互补
