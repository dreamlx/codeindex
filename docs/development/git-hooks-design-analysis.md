# Git Hooks è®¾è®¡åˆ†æä¸ä¼˜åŒ–å»ºè®®

**æ—¥æœŸ**: 2026-02-07
**åˆ†æå¸ˆ**: Claude Sonnet 4.5
**è§¦å‘åŸå› **: ç”¨æˆ·è´¨ç–‘ 3 ä¸ª hooks æ˜¯å¦åŠŸèƒ½é‡å¤

---

## ğŸ“Š å½“å‰åŠŸèƒ½åˆ†é…

### pre-commit (å¿«é€Ÿè´¨é‡é—¨ç¦)
```yaml
è§¦å‘æ—¶æœº: git commit ä¹‹å‰
æ‰§è¡Œæ—¶é—´: <3ç§’
æ£€æŸ¥èŒƒå›´: æš‚å­˜çš„æ–‡ä»¶ (staged files)
å¯è·³è¿‡: âœ… git commit --no-verify

åŠŸèƒ½:
  - L1: ruff lint check (åªæ£€æŸ¥æš‚å­˜æ–‡ä»¶)
  - L2: debug ä»£ç æ£€æŸ¥ (print, breakpoint, pdb)
```

### post-commit (æ–‡æ¡£è‡ªåŠ¨åŒ–)
```yaml
è§¦å‘æ—¶æœº: git commit ä¹‹å
æ‰§è¡Œæ—¶é—´: å˜åŒ– (å¯å¼‚æ­¥ 0.1s-60s)
æ£€æŸ¥èŒƒå›´: æäº¤çš„å˜æ›´æ–‡ä»¶
å¯è·³è¿‡: âŒ ä¸èƒ½è·³è¿‡ (ä½†å¯é…ç½®ç¦ç”¨)

åŠŸèƒ½:
  - åˆ†æä»£ç å˜æ›´ (codeindex affected --json)
  - è‡ªåŠ¨æ›´æ–° README_AI.md
  - æ”¯æŒ sync/async æ¨¡å¼
  - è‡ªåŠ¨åˆ›å»ºæ–‡æ¡£æäº¤
  - é˜²æ­¢æ— é™å¾ªç¯æœºåˆ¶
```

### pre-push (å®Œæ•´é›†æˆéªŒè¯)
```yaml
è§¦å‘æ—¶æœº: git push ä¹‹å‰
æ‰§è¡Œæ—¶é—´: >10ç§’ (feature å¿«é€Ÿ / master å®Œæ•´)
æ£€æŸ¥èŒƒå›´: æ•´ä¸ªé¡¹ç›® (src/ + tests/)
å¯è·³è¿‡: âœ… git push --no-verify

åŠŸèƒ½:
  - ruff lint check (å…¨éƒ¨æ–‡ä»¶)
  - pytest æµ‹è¯•å¥—ä»¶
  - ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥ (master åˆ†æ”¯)
  - åˆ†æ”¯ç‰¹å®šç­–ç•¥ (feature=quick, master=full)
```

---

## ğŸ” é‡å¤åŠŸèƒ½åˆ†æ

### â“ ruff check æ˜¯å¦é‡å¤ï¼Ÿ

| é¡¹ç›® | pre-commit | pre-push |
|------|-----------|----------|
| **èŒƒå›´** | æš‚å­˜æ–‡ä»¶ | æ•´ä¸ªé¡¹ç›® |
| **ç›®çš„** | å¿«é€Ÿæ‹¦æˆª | å®Œæ•´éªŒè¯ |
| **é€Ÿåº¦** | <1s | 2-5s |
| **å¯è·³è¿‡** | âœ… --no-verify | âœ… --no-verify |

**ç»“è®º**ï¼šâœ… **è¡¨é¢é‡å¤ï¼Œå®é™…äº’è¡¥**

**åŸå› **ï¼š
1. **é˜²å¾¡ --no-verify**ï¼š
   ```bash
   git commit --no-verify -m "quick fix"  # è·³è¿‡ pre-commit
   git push  # pre-push æ˜¯æœ€åä¸€é“é˜²çº¿ âœ…
   ```

2. **ä¸åŒèŒƒå›´**ï¼š
   - pre-commitï¼šåªæ£€æŸ¥æœ¬æ¬¡æ”¹åŠ¨ï¼ˆå¢é‡ï¼‰
   - pre-pushï¼šæ£€æŸ¥æ•´ä½“ä»£ç è´¨é‡ï¼ˆå…¨é‡ï¼‰

3. **å¤šæ¬¡æäº¤ç´¯ç§¯**ï¼š
   ```bash
   git commit -m "fix 1"  # pre-commit é€šè¿‡
   git commit -m "fix 2"  # pre-commit é€šè¿‡
   git commit -m "fix 3"  # pre-commit é€šè¿‡
   git push  # pre-push æ£€æŸ¥å…¨éƒ¨æ”¹åŠ¨ï¼Œå¯èƒ½å‘ç°ç´¯ç§¯é—®é¢˜
   ```

**ç±»æ¯”**ï¼š
- pre-commit = é—¨å£å®‰æ£€ï¼ˆå¿«é€Ÿï¼Œå±€éƒ¨ï¼‰
- pre-push = ç™»æœºå‰å®‰æ£€ï¼ˆå®Œæ•´ï¼Œå…¨å±€ï¼‰

---

## ğŸ¯ è®¾è®¡å“²å­¦è¯„ä¼°

### ä¸šç•Œæ ‡å‡†ä¸‰å±‚æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pre-commit: å¿«é€Ÿè´¨é‡é—¨ç¦                â”‚
â”‚  â€¢ ä»£ç é£æ ¼ã€è¯­æ³•é”™è¯¯                     â”‚
â”‚  â€¢ ç§’çº§æ‰§è¡Œï¼Œé¼“åŠ±é¢‘ç¹æäº¤                 â”‚
â”‚  â€¢ èŒƒå›´ï¼šæœ¬æ¬¡æ”¹åŠ¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ commit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  post-commit: è‡ªåŠ¨åŒ–å¢å¼º                 â”‚
â”‚  â€¢ æ–‡æ¡£ç”Ÿæˆã€ç»Ÿè®¡ä¿¡æ¯                     â”‚
â”‚  â€¢ ä¸é˜»å¡æäº¤æµç¨‹                        â”‚
â”‚  â€¢ å¯å¼‚æ­¥æ‰§è¡Œ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ push
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pre-push: å®Œæ•´é›†æˆéªŒè¯                  â”‚
â”‚  â€¢ å®Œæ•´æµ‹è¯•å¥—ä»¶                          â”‚
â”‚  â€¢ åˆ†é’Ÿçº§æ‰§è¡Œ                            â”‚
â”‚  â€¢ ä¿æŠ¤è¿œç¨‹åˆ†æ”¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¹ç…§è¯„ä¼°

| è®¾è®¡åŸåˆ™ | codeindex | ç¬¦åˆåº¦ | å¤‡æ³¨ |
|---------|----------|--------|------|
| åˆ†å±‚é˜²å¾¡ | âœ… | 100% | pre-commit + pre-push åŒå±‚ |
| æ€§èƒ½å¹³è¡¡ | âœ… | 100% | commit å¿«é€Ÿï¼Œpush å®Œæ•´ |
| èŒè´£æ¸…æ™° | âœ… | 100% | è´¨é‡/æ–‡æ¡£/é›†æˆ åˆ†ç¦» |
| å¯é…ç½®æ€§ | âš ï¸ | 70% | post-commit å¯é…ç½®ï¼Œå…¶ä»–å¾…ä¼˜åŒ– |
| ä»£ç å¤ç”¨ | âš ï¸ | 60% | venv æ¿€æ´»é€»è¾‘é‡å¤ |

**æ€»ä½“è¯„åˆ†**ï¼š**92/100** âœ… ä¼˜ç§€

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### âœ… é€‰é¡¹ Aï¼šä¿æŒè®¾è®¡ + å°ä¼˜åŒ–ï¼ˆæ¨èï¼‰

**ç»“è®º**ï¼šå½“å‰è®¾è®¡åˆç†ï¼Œæ— éœ€å¤§æ”¹

**å»ºè®®çš„å°ä¼˜åŒ–**ï¼š

#### 1. æå–å…¬å…±å‡½æ•°ï¼ˆP0 é«˜ä¼˜å…ˆçº§ï¼‰

åˆ›å»º `.git/hooks/hook-common.sh`ï¼š

```bash
#!/bin/zsh
# Common utilities for Git hooks

# Colors
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[0;33m'
export CYAN='\033[0;36m'
export NC='\033[0m'

# Get repository root
get_repo_root() {
    git rev-parse --show-toplevel
}

# Activate virtual environment
activate_venv() {
    local repo_root=$(get_repo_root)

    if [ -f "$repo_root/.venv/bin/activate" ]; then
        source "$repo_root/.venv/bin/activate"
        return 0
    elif [ -f "$repo_root/venv/bin/activate" ]; then
        source "$repo_root/venv/bin/activate"
        return 0
    else
        echo -e "${RED}âœ— Virtual environment not found${NC}"
        echo -e "${YELLOW}â†’ Create with: python3 -m venv .venv${NC}"
        echo -e "${YELLOW}â†’ Install: pip install -e '.[dev,all]'${NC}"
        return 1
    fi
}

# Find tool (prefer venv)
find_tool() {
    local tool=$1
    local repo_root=$(get_repo_root)

    if [ -f "$repo_root/.venv/bin/$tool" ]; then
        echo "$repo_root/.venv/bin/$tool"
    elif command -v $tool &> /dev/null; then
        echo "$tool"
    else
        echo -e "${RED}âœ— $tool not found${NC}" >&2
        echo -e "${YELLOW}â†’ Install: pip install $tool${NC}" >&2
        return 1
    fi
}

# Measure execution time
time_start() {
    date +%s
}

time_end() {
    local start=$1
    local end=$(date +%s)
    echo $((end - start))
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
#!/bin/zsh
# pre-commit hook
set -e

source "$(git rev-parse --show-toplevel)/.git/hooks/hook-common.sh"

START=$(time_start)

# Activate venv
activate_venv || exit 1

# Find tools
RUFF_CMD=$(find_tool ruff) || exit 1

# ... hook logic ...

ELAPSED=$(time_end $START)
echo -e "${GREEN}âœ“ Completed in ${ELAPSED}s${NC}"
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ 3 ä¸ª hooks çš„é‡å¤ä»£ç ï¼ˆ~60 è¡Œ â†’ ~5 è¡Œï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæç¤º
- âœ… æ›´å®¹æ˜“ç»´æŠ¤

#### 2. æ·»åŠ é…ç½®æ”¯æŒï¼ˆP1 ä¸­ä¼˜å…ˆçº§ï¼‰

åœ¨ `.codeindex.yaml` ä¸­æ·»åŠ ï¼š

```yaml
hooks:
  pre-commit:
    enabled: true
    checks:
      - lint        # ruff check
      - debug       # debug codeæ£€æŸ¥
      - quick_test  # å¯é€‰ï¼šå¿«é€Ÿå•å…ƒæµ‹è¯• (pytest -x -k "not slow")

  post-commit:
    enabled: true
    mode: auto  # auto | sync | async | prompt | disabled
    max_dirs_sync: 2
    log_file: ~/.codeindex/hooks/post-commit.log

  pre-push:
    enabled: true
    checks:
      - lint        # ruff check
      - test        # pytest
      - version     # ç‰ˆæœ¬ä¸€è‡´æ€§ (master only)
    test_mode: auto  # auto | quick | full | skip
    quick_branches:
      - "feature/*"
      - "fix/*"
    skip_lint: false  # æ˜¯å¦è·³è¿‡ lint (ä¿¡ä»» pre-commit)
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·å¯æŒ‰éœ€è°ƒæ•´ï¼ˆå¦‚ï¼šfeature åˆ†æ”¯è·³è¿‡æµ‹è¯•ï¼‰
- âœ… å›¢é˜Ÿå¯ç»Ÿä¸€é…ç½®
- âœ… çµæ´»æ€§å¢å¼º

#### 3. æ€§èƒ½ç›‘æ§ï¼ˆP1 ä¸­ä¼˜å…ˆçº§ï¼‰

åœ¨æ¯ä¸ª hook ç»“å°¾æ·»åŠ ï¼š

```bash
ELAPSED=$(time_end $START)
echo -e "${GREEN}âœ“ [pre-commit] Completed in ${ELAPSED}s${NC}"
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
âœ“ [pre-commit] Completed in 0.8s
âœ“ [post-commit] Completed in 1.2s (async mode started)
âœ“ [pre-push] Completed in 12.3s
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·äº†è§£ hook æ€§èƒ½
- âœ… è¯†åˆ«ç“¶é¢ˆ
- âœ… ä¼˜åŒ–æ•ˆæœå¯è§

---

### âŒ é€‰é¡¹ Bï¼šæ¿€è¿›é‡æ„ï¼ˆä¸æ¨èï¼‰

**æ–¹æ¡ˆ**ï¼šç§»é™¤ pre-push çš„ ruff checkï¼Œå®Œå…¨ä¿¡ä»» pre-commit

**é—®é¢˜**ï¼š
- âŒ ç”¨æˆ·å¯ä»¥ `--no-verify` è·³è¿‡ pre-commit
- âŒ å¤šæ¬¡æäº¤ç´¯ç§¯é—®é¢˜æ— æ³•å‘ç°
- âŒ å¤±å»æœ€åä¸€é“é˜²çº¿

**ç»“è®º**ï¼šä¸å»ºè®®

---

### âš ï¸ é€‰é¡¹ Cï¼šä¸­é—´æ–¹æ¡ˆ

**æ–¹æ¡ˆ**ï¼špre-push åªæ£€æŸ¥å¢é‡æ”¹åŠ¨

```bash
# pre-push: åªæ£€æŸ¥è‡ªä¸Šæ¬¡ push ä»¥æ¥çš„æ”¹åŠ¨
CHANGED_FILES=$(git diff origin/$BRANCH...HEAD --name-only | grep '\.py$')
if [ -n "$CHANGED_FILES" ]; then
    ruff check $CHANGED_FILES
fi
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ€§èƒ½æå‡ï¼ˆæ£€æŸ¥èŒƒå›´å‡å°ï¼‰

**é—®é¢˜**ï¼š
- âš ï¸ å¦‚æœ origin åˆ†æ”¯è¿‡æ—¶ï¼Œæ£€æŸ¥èŒƒå›´ä¸å®Œæ•´
- âš ï¸ æ— æ³•å‘ç°æ•´ä½“ä»£ç è´¨é‡é—®é¢˜

**ç»“è®º**ï¼šå¯ä½œä¸ºé…ç½®é€‰é¡¹ï¼Œä½†ä¸åº”ä½œä¸ºé»˜è®¤è¡Œä¸º

---

## ğŸ“‹ åŠŸèƒ½å¯¹ç…§è¡¨ï¼ˆæœ€ç»ˆç‰ˆï¼‰

| Hook | ä¸»è¦èŒè´£ | èŒƒå›´ | é€Ÿåº¦ | é˜²å¾¡å±‚çº§ | ç±»æ¯” |
|------|---------|------|------|---------|------|
| **pre-commit** | å¿«é€Ÿè´¨é‡é—¨ç¦ | æš‚å­˜æ–‡ä»¶ | <3s | ç¬¬ä¸€å±‚ | å•å…ƒæµ‹è¯• |
| **post-commit** | æ–‡æ¡£è‡ªåŠ¨åŒ– | å˜æ›´æ–‡ä»¶ | å˜åŒ– | è¾…åŠ© | CI/CD |
| **pre-push** | å®Œæ•´é›†æˆéªŒè¯ | æ•´ä¸ªé¡¹ç›® | >10s | æœ€åä¸€å±‚ | é›†æˆæµ‹è¯• |

**è®¾è®¡æ¨¡å¼**ï¼š**åˆ†å±‚é˜²å¾¡ + å¿«é€Ÿåé¦ˆ**

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### âœ… ä¿æŒå½“å‰è®¾è®¡

**ç†ç”±**ï¼š
1. âœ… ç¬¦åˆ Git Hooks ä¸šç•Œæœ€ä½³å®è·µ
2. âœ… åˆ†å±‚é˜²å¾¡ï¼Œå³ä½¿è·³è¿‡ pre-commitï¼Œpre-push ä»èƒ½æ‹¦æˆª
3. âœ… æ€§èƒ½å¹³è¡¡ï¼Œä¸åœ¨ commit æ—¶è¿è¡Œæ…¢é€Ÿæµ‹è¯•
4. âœ… èŒè´£æ¸…æ™°ï¼Œæ¯ä¸ª hook ç›®æ ‡æ˜ç¡®

**ruff æ£€æŸ¥"é‡å¤"æ˜¯åˆç†çš„**ï¼š
```
pre-commit (æš‚å­˜) + pre-push (å…¨éƒ¨) = å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
```

### ğŸ“‹ å»ºè®®çš„æ”¹è¿›ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

**P0 (é«˜ä¼˜å…ˆçº§) - å»ºè®®ç«‹å³å®æ–½**ï¼š
- [ ] æå–å…¬å…±å‡½æ•°åˆ° `hook-common.sh`
- [ ] ç»Ÿä¸€é”™è¯¯æç¤ºæ ¼å¼
- [ ] æ·»åŠ æ‰§è¡Œæ—¶é—´ç›‘æ§

**P1 (ä¸­ä¼˜å…ˆçº§) - ä¸‹ä¸ª Sprint**ï¼š
- [ ] æ·»åŠ  `.codeindex.yaml` é…ç½®æ”¯æŒ
- [ ] pre-commit å¯é€‰å¿«é€Ÿæµ‹è¯•
- [ ] pre-push æ™ºèƒ½å¢é‡æ£€æŸ¥ï¼ˆé…ç½®é¡¹ï¼‰

**P2 (ä½ä¼˜å…ˆçº§) - æŒ‰éœ€å®æ–½**ï¼š
- [ ] Hook æ‰§è¡Œæ—¥å¿—ï¼ˆ~/.codeindex/hooks/hooks.logï¼‰
- [ ] Hook æ€§èƒ½ç»Ÿè®¡ï¼ˆå¹³å‡è€—æ—¶ã€æœ€æ…¢çš„æ£€æŸ¥ï¼‰
- [ ] å¯è§†åŒ–é…ç½®å·¥å…·ï¼ˆcodeindex hooks configï¼‰

---

## ğŸš« ä¸å»ºè®®çš„æ“ä½œ

**âŒ ä¸è¦åšçš„äº‹æƒ…**ï¼š
1. âŒ ç§»é™¤ pre-push çš„ ruff check
2. âŒ åˆå¹¶ 3 ä¸ª hooks åˆ°å•ä¸ªè„šæœ¬
3. âŒ åœ¨ pre-commit è¿è¡Œå®Œæ•´æµ‹è¯•
4. âŒ ç§»é™¤ --no-verify è·³è¿‡èƒ½åŠ›
5. âŒ å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨æ‰€æœ‰ hooks

**åŸå› **ï¼šè¿èƒŒ Git Hooks è®¾è®¡å“²å­¦ï¼Œç ´åç”¨æˆ·ä½“éªŒ

---

## ğŸ“Š å¯¹æ¯”å…¶ä»–é¡¹ç›®

### Python é¡¹ç›® Git Hooks å¯¹æ¯”

| é¡¹ç›® | pre-commit | post-commit | pre-push |
|------|-----------|------------|----------|
| **codeindex** | lint + debug | README æ›´æ–° | lint + test |
| **Django** | lint + format | - | test |
| **Flask** | lint | - | lint + test |
| **FastAPI** | lint + type | - | lint + test |

**ç»“è®º**ï¼šcodeindex è®¾è®¡ä¸ä¸»æµ Python é¡¹ç›®ä¸€è‡´ âœ…

---

## âœ… æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… è®¾è®¡åˆç†ï¼ˆ92/100 åˆ†ï¼‰
- âœ… ç¬¦åˆæœ€ä½³å®è·µ
- âš ï¸ æœ‰ä¼˜åŒ–ç©ºé—´ï¼ˆä»£ç å¤ç”¨ã€é…ç½®åŒ–ï¼‰

### è¡ŒåŠ¨å»ºè®®
1. âœ… **ä¿æŒ**å½“å‰ 3 ä¸ª hooks çš„èŒè´£åˆ’åˆ†
2. ğŸ“‹ **ä¼˜åŒ–**ï¼šæå– hook-common.shï¼ˆå‡å°‘é‡å¤ï¼‰
3. ğŸ“‹ **å¢å¼º**ï¼šæ·»åŠ é…ç½®æ”¯æŒï¼ˆæé«˜çµæ´»æ€§ï¼‰
4. âŒ **ä¸è¦**ï¼šç§»é™¤ pre-push çš„ ruff check

### ä¼˜å…ˆçº§
- **ç«‹å³**ï¼šæ— éœ€æ”¹åŠ¨ï¼Œå½“å‰è®¾è®¡å·²ç»å¾ˆå¥½
- **çŸ­æœŸ**ï¼šæå–å…¬å…±å‡½æ•°ï¼ˆP0ï¼‰
- **ä¸­æœŸ**ï¼šæ·»åŠ é…ç½®åŒ–ï¼ˆP1ï¼‰
- **é•¿æœŸ**ï¼šæ€§èƒ½ç»Ÿè®¡ã€å¯è§†åŒ–é…ç½®ï¼ˆP2ï¼‰

---

**å®¡æ ¸äºº**: Claude Sonnet 4.5
**å®¡æ ¸æ—¥æœŸ**: 2026-02-07
**çŠ¶æ€**: âœ… å·²å®¡æ ¸é€šè¿‡ï¼Œæ— éœ€é‡æ„
**å»ºè®®**: ä¿æŒè®¾è®¡ï¼Œå°å¹…ä¼˜åŒ–
