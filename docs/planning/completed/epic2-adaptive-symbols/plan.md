# Epic 2: è‡ªé€‚åº”ç¬¦å·æå– - è¯¦ç»†è§„åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-01-26
**è´Ÿè´£äºº**: Development Team
**ä¼˜å…ˆçº§**: P0 (å…³é”®)
**é¢„è®¡æ—¶é—´**: 9-13å°æ—¶ï¼ˆ1-1.5å¤©ï¼‰

## ğŸ“‹ Epicæ¦‚è¿°

### é—®é¢˜é™ˆè¿°

å½“å‰ç³»ç»Ÿå¯¹æ‰€æœ‰æ–‡ä»¶å›ºå®šæ˜¾ç¤º15ä¸ªç¬¦å·ï¼Œå¯¼è‡´ï¼š
- **å¤§æ–‡ä»¶ä¿¡æ¯ä¸¢å¤±ä¸¥é‡**ï¼š8,891è¡Œæ–‡ä»¶åªæ˜¾ç¤º15ä¸ªç¬¦å·ï¼ˆè¦†ç›–ç‡0.17%ï¼‰
- **è¯„åˆ†ç³»ç»Ÿä»·å€¼æœ‰é™**ï¼šç²¾å¿ƒè®¾è®¡çš„5ç»´è¯„åˆ†ç³»ç»Ÿåªèƒ½"ä»15ä¸ªä¸­é€‰15ä¸ª"
- **ç”¨æˆ·ä½“éªŒæå·®**ï¼šå¹³å‡ä¸¢å¤±68%çš„ç¬¦å·ä¿¡æ¯

### ç›®æ ‡

å®ç°åŸºäºæ–‡ä»¶å¤§å°çš„è‡ªé€‚åº”ç¬¦å·æå–ç³»ç»Ÿï¼š
- å¤§æ–‡ä»¶æ˜¾ç¤ºæ›´å¤šç¬¦å·ï¼ˆ80-120ä¸ªï¼‰
- å°æ–‡ä»¶ä¿æŒåˆç†æ•°é‡ï¼ˆ10-15ä¸ªï¼‰
- ä¿¡æ¯è¦†ç›–ç‡æå‡è‡³80%+
- ä¿æŒå‘åå…¼å®¹æ€§

### æˆåŠŸæ ‡å‡†

- âœ… 8,891è¡Œæ–‡ä»¶æ˜¾ç¤º120ä¸ªç¬¦å·ï¼ˆå½“å‰15ä¸ªï¼‰
- âœ… è¦†ç›–ç‡ä»26%æå‡åˆ°80%+
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡>90%
- âœ… å‘åå…¼å®¹æ€§ä¿æŒ
- âœ… æ€§èƒ½å¼€é”€<30%

## ğŸ¯ Storyåˆ†è§£

### Phase 1: é…ç½®åŸºç¡€ (4-6å°æ—¶)

#### Story 2.1.1: è‡ªé€‚åº”é…ç½®æ•°æ®ç»“æ„è®¾è®¡ â­

**æè¿°**: å®šä¹‰AdaptiveSymbolsConfigæ•°æ®ç±»å’Œé»˜è®¤é…ç½®

**ä»»åŠ¡**:
- [ ] åˆ›å»º`src/codeindex/adaptive_config.py`
- [ ] å®šä¹‰`AdaptiveSymbolsConfig`æ•°æ®ç±»
  - `enabled: bool = False`
  - `thresholds: dict[str, int]`
  - `limits: dict[str, int]`
  - `min_symbols: int = 5`
  - `max_symbols: int = 200`
- [ ] å®šä¹‰`DEFAULT_ADAPTIVE_CONFIG`å¸¸é‡
- [ ] æ·»åŠ å®Œæ•´docstringè¯´æ˜
- [ ] åˆ›å»ºæµ‹è¯•æ–‡ä»¶`tests/test_adaptive_config.py`

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ•°æ®ç±»å®šä¹‰å®Œæˆï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
- âœ… DEFAULT_CONFIGåŒ…å«åˆç†çš„é»˜è®¤å€¼
- âœ… å®Œæ•´çš„docstringæ–‡æ¡£
- âœ… æµ‹è¯•è¦†ç›–ç‡>90%

**ä¼°æ—¶**: 2-3å°æ—¶

#### Story 2.1.2: é…ç½®åŠ è½½å’ŒéªŒè¯

**æè¿°**: åœ¨Configç±»ä¸­åŠ è½½å’ŒéªŒè¯adaptive_symbolsé…ç½®

**ä¾èµ–**: Story 2.1.1

**ä»»åŠ¡**:
- [ ] ä¿®æ”¹`src/codeindex/config.py`
- [ ] æ·»åŠ `adaptive_symbols`å­—æ®µåˆ°Configç±»
- [ ] å®ç°é…ç½®åŠ è½½é€»è¾‘ï¼ˆYAML â†’ AdaptiveSymbolsConfigï¼‰
- [ ] å®ç°é…ç½®éªŒè¯ï¼š
  - æ£€æŸ¥thresholdsé€’å¢
  - æ£€æŸ¥limitsåˆç†ï¼ˆmin <= limit <= maxï¼‰
- [ ] å®ç°é…ç½®åˆå¹¶ï¼ˆç”¨æˆ·é…ç½® + é»˜è®¤é…ç½®ï¼‰
- [ ] å‘åå…¼å®¹ï¼šenabled=falseæ—¶ä½¿ç”¨max_per_file
- [ ] æ·»åŠ æµ‹è¯•ç”¨ä¾‹

**éªŒæ”¶æ ‡å‡†**:
- âœ… Configèƒ½æ­£ç¡®åŠ è½½adaptive_symbolsé…ç½®
- âœ… é…ç½®éªŒè¯æ•è·é”™è¯¯é…ç½®
- âœ… å‘åå…¼å®¹æµ‹è¯•é€šè¿‡
- âœ… é…ç½®åˆå¹¶é€»è¾‘æ­£ç¡®
- âœ… æµ‹è¯•è¦†ç›–ç‡>90%

**ä¼°æ—¶**: 2-3å°æ—¶

### Phase 2: æ ¸å¿ƒç®—æ³• (3-4å°æ—¶)

#### Story 2.2.1: è‡ªé€‚åº”é€‰æ‹©å™¨å®ç° â­â­

**æè¿°**: å®ç°AdaptiveSymbolSelectoræ ¸å¿ƒç®—æ³•

**ä¾èµ–**: Story 2.1.2

**ä»»åŠ¡**:
- [ ] åˆ›å»º`src/codeindex/adaptive_selector.py`
- [ ] å®ç°`AdaptiveSymbolSelector`ç±»
- [ ] å®ç°æ ¸å¿ƒæ–¹æ³•ï¼š
  ```python
  def calculate_limit(file_lines: int, total_symbols: int) -> int
  def _determine_size_category(lines: int) -> str
  def _apply_constraints(limit: int) -> int
  ```
- [ ] åˆ›å»ºæµ‹è¯•æ–‡ä»¶`tests/test_adaptive_selector.py`
- [ ] å®ç°æµ‹è¯•ç”¨ä¾‹ï¼š
  - åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼ˆ5ä¸ªï¼‰
  - æ–‡ä»¶å¤§å°åˆ†ç±»æµ‹è¯•ï¼ˆ7ä¸ªï¼‰
  - çº¦æŸåº”ç”¨æµ‹è¯•ï¼ˆ3ä¸ªï¼‰
  - è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ4ä¸ªï¼‰
  - çœŸå®PHPé¡¹ç›®æµ‹è¯•ï¼ˆ2ä¸ªï¼‰

**ç®—æ³•é€»è¾‘**:
```python
def calculate_limit(file_lines, total_symbols):
    # 1. ç¡®å®šæ–‡ä»¶å¤§å°åˆ†ç±»
    category = _determine_size_category(file_lines)

    # 2. è·å–å¯¹åº”çš„ç¬¦å·é™åˆ¶
    limit = config.limits[category]

    # 3. åº”ç”¨çº¦æŸ
    limit = min(limit, total_symbols)  # ä¸è¶…è¿‡å®é™…ç¬¦å·æ•°
    limit = max(limit, config.min_symbols)  # è‡³å°‘minä¸ª
    limit = min(limit, config.max_symbols)  # è‡³å¤šmaxä¸ª

    return limit
```

**åˆ†ç±»è§„åˆ™**:
```
<100è¡Œ    â†’ tiny   â†’ 10ç¬¦å·
100-200   â†’ small  â†’ 15ç¬¦å·
200-500   â†’ medium â†’ 30ç¬¦å·
500-1000  â†’ large  â†’ 50ç¬¦å·
1000-2000 â†’ xlarge â†’ 80ç¬¦å·
2000-5000 â†’ huge   â†’ 120ç¬¦å·
>5000     â†’ mega   â†’ 150ç¬¦å·
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… AdaptiveSymbolSelectorç±»å®ç°å®Œæˆ
- âœ… calculate_limit()è¿”å›æ­£ç¡®ç»“æœ
- âœ… æ‰€æœ‰æ–‡ä»¶å¤§å°åˆ†æ®µæµ‹è¯•é€šè¿‡
- âœ… è¾¹ç•Œæƒ…å†µå¤„ç†æ­£ç¡®
- âœ… PHPé¡¹ç›®æµ‹è¯•ï¼š8891è¡Œâ†’120ç¬¦å·
- âœ… æµ‹è¯•è¦†ç›–ç‡>95%

**ä¼°æ—¶**: 3-4å°æ—¶

### Phase 3: é›†æˆ (2-3å°æ—¶)

#### Story 2.2.3: é›†æˆåˆ°SmartWriter â­â­â­

**æè¿°**: å°†AdaptiveSymbolSelectoré›†æˆåˆ°SmartWriter

**ä¾èµ–**: Story 2.2.1

**ä»»åŠ¡**:
- [ ] ä¿®æ”¹`src/codeindex/smart_writer.py`
- [ ] æ·»åŠ AdaptiveSymbolSelectoråˆå§‹åŒ–
- [ ] æ›¿æ¢ç¡¬ç¼–ç çš„`max_per_file`ä¸ºåŠ¨æ€è®¡ç®—
- [ ] ä¿®æ”¹ç¬¦å·é€‰æ‹©é€»è¾‘ï¼š
  ```python
  # æ—§ä»£ç 
  max_symbols = 15

  # æ–°ä»£ç 
  file_lines = content.count('\n') + 1
  max_symbols = self.adaptive_selector.calculate_limit(
      file_lines, len(symbols)
  )
  ```
- [ ] æ·»åŠ æ—¥å¿—è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰
- [ ] åˆ›å»ºé›†æˆæµ‹è¯•
- [ ] è¿è¡Œå›å½’æµ‹è¯•
- [ ] PHPé¡¹ç›®ç«¯åˆ°ç«¯éªŒè¯

**éªŒæ”¶æ ‡å‡†**:
- âœ… SmartWriteræˆåŠŸé›†æˆAdaptiveSymbolSelector
- âœ… ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„max_per_fileå¼•ç”¨
- âœ… åŠŸèƒ½æµ‹è¯•ï¼šå°/ä¸­/å¤§æ–‡ä»¶éªŒè¯é€šè¿‡
- âœ… å›å½’æµ‹è¯•ï¼šç°æœ‰41ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… PHPé¡¹ç›®éªŒè¯ï¼šREADME_AI.mdåŒ…å«80+ç¬¦å·
- âœ… æµ‹è¯•è¦†ç›–ç‡ä¿æŒ>90%

**ä¼°æ—¶**: 2-3å°æ—¶

## ğŸ”§ é…ç½®è®¾è®¡

### é…ç½®Schema

```yaml
symbols:
  # ä¼ ç»Ÿå›ºå®šé…ç½®ï¼ˆå‘åå…¼å®¹ï¼‰
  max_per_file: 15

  # æ–°çš„è‡ªé€‚åº”é…ç½®
  adaptive_symbols:
    enabled: true  # æ˜¯å¦å¯ç”¨è‡ªé€‚åº”

    # æ–‡ä»¶å¤§å°é˜ˆå€¼ï¼ˆè¡Œæ•°ï¼‰
    thresholds:
      tiny: 100
      small: 200
      medium: 500
      large: 1000
      xlarge: 2000
      huge: 5000

    # æ¯ä¸ªåˆ†æ®µçš„ç¬¦å·æ•°é‡é™åˆ¶
    limits:
      tiny: 10
      small: 15
      medium: 30
      large: 50
      xlarge: 80
      huge: 120
      mega: 150  # >5000è¡Œ

    # å…¨å±€é™åˆ¶
    min_symbols: 5    # æœ€å°‘æ˜¾ç¤ºç¬¦å·æ•°
    max_symbols: 200  # æœ€å¤šæ˜¾ç¤ºç¬¦å·æ•°
```

### é…ç½®ç¤ºä¾‹

**ç¤ºä¾‹1: å¯ç”¨è‡ªé€‚åº”ï¼ˆä½¿ç”¨é»˜è®¤ï¼‰**
```yaml
symbols:
  adaptive_symbols:
    enabled: true
```

**ç¤ºä¾‹2: å¤§å‹é¡¹ç›®é…ç½®**
```yaml
symbols:
  adaptive_symbols:
    enabled: true
    limits:
      large: 80
      xlarge: 150
      huge: 200
    max_symbols: 250
```

**ç¤ºä¾‹3: ä¿å®ˆé…ç½®**
```yaml
symbols:
  adaptive_symbols:
    enabled: true
    limits:
      large: 30
      xlarge: 50
      huge: 80
    max_symbols: 100
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ test_adaptive_config.py      # Story 2.1.1æµ‹è¯•
â”œâ”€â”€ test_config_loading.py       # Story 2.1.2æµ‹è¯•ï¼ˆæ‰©å±•ç°æœ‰ï¼‰
â”œâ”€â”€ test_adaptive_selector.py    # Story 2.2.1æµ‹è¯•
â””â”€â”€ test_integration_adaptive.py # Story 2.2.3é›†æˆæµ‹è¯•
```

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| ç»„ä»¶ | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|
| adaptive_config.py | >90% |
| config.py (æ–°å¢éƒ¨åˆ†) | >90% |
| adaptive_selector.py | >95% |
| smart_writer.py (ä¿®æ”¹éƒ¨åˆ†) | >90% |
| **æ•´ä½“** | **>90%** |

### çœŸå®é¡¹ç›®éªŒè¯

**PHPé¡¹ç›®**:
- è·¯å¾„: `~/Projects/php_admin-main-c59644bb607125803a5d14400b64be9068b82488`
- æµ‹è¯•æ–‡ä»¶: OperateGoods.class.php (8,891è¡Œ)
- é¢„æœŸ: æ˜¾ç¤º120ä¸ªç¬¦å·ï¼ˆå½“å‰15ä¸ªï¼‰
- è¦†ç›–ç‡: 26% â†’ 80%+

**Pythoné¡¹ç›®** (codeindexè‡ªèº«):
- æµ‹è¯•ä¸åŒå¤§å°çš„æºæ–‡ä»¶
- éªŒè¯é…ç½®æ­£ç¡®åŠ è½½
- ç¡®ä¿è‡ªä¸¾å¯ç”¨

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ç¬¦å·æ•°é‡å¯¹æ¯”

| æ–‡ä»¶å¤§å° | å½“å‰ | æ”¹è¿›å | æå‡ |
|---------|------|--------|------|
| 8,891è¡Œ | 15 | 120 | +700% |
| 7,924è¡Œ | 15 | 120 | +700% |
| 4,888è¡Œ | 15 | 80 | +433% |
| 3,521è¡Œ | 15 | 50 | +233% |
| 500è¡Œ | 15 | 30 | +100% |
| 150è¡Œ | 15 | 15 | 0% |

### è¦†ç›–ç‡å¯¹æ¯”

| æŒ‡æ ‡ | å½“å‰ | æ”¹è¿›å | æå‡ |
|------|------|--------|------|
| å¤§æ–‡ä»¶è¦†ç›–ç‡ | 26% | 80%+ | +208% |
| ç”¨æˆ·æ»¡æ„åº¦ | 20% | 75%+ | +275% |
| ä¿¡æ¯å®Œæ•´åº¦ | åŸºå‡† | 3-7x | æ˜¾è‘— |

### æ€§èƒ½å½±å“

| æŒ‡æ ‡ | å½“å‰ | æ”¹è¿›å | å˜åŒ– |
|------|------|--------|------|
| è§£ææ—¶é—´ | åŸºå‡† | åŸºå‡† | 0% |
| å†™å…¥æ—¶é—´ | åŸºå‡† | +20% | å¯æ¥å— |
| AIå¤„ç†æ—¶é—´ | åŸºå‡† | +10-20% | å¯æ¥å— |
| å†…å­˜å ç”¨ | åŸºå‡† | +5% | å¯å¿½ç•¥ |

## ğŸš¨ é£é™©å’Œç¼“è§£

### é£é™©1: README_AI.mdè¿‡é•¿
- **å¯èƒ½æ€§**: ä¸­ç­‰
- **ç¼“è§£**: max_symbolsä¸Šé™ï¼ˆ200ï¼‰ï¼Œç”¨æˆ·å¯é…ç½®

### é£é™©2: AI promptè¶…é™
- **å¯èƒ½æ€§**: ä½
- **ç¼“è§£**: ç›‘æ§é•¿åº¦ï¼Œè¶…é™æ—¶è‡ªåŠ¨é™çº§

### é£é™©3: é…ç½®é”™è¯¯
- **å¯èƒ½æ€§**: ä¸­ç­‰
- **ç¼“è§£**: é…ç½®éªŒè¯ï¼Œè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œé»˜è®¤å€¼fallback

### é£é™©4: ç ´åç°æœ‰åŠŸèƒ½
- **å¯èƒ½æ€§**: ä½
- **ç¼“è§£**: å®Œæ•´å›å½’æµ‹è¯•ï¼Œå‘åå…¼å®¹è®¾è®¡

## ğŸ“… å®æ–½è®¡åˆ’

### Day 3ä¸Šåˆ (4å°æ—¶)
- âœ… Story 2.1.1: é…ç½®æ•°æ®ç»“æ„
- âœ… Story 2.1.2: é…ç½®åŠ è½½

### Day 3ä¸‹åˆ (4å°æ—¶)
- âœ… Story 2.2.1: æ ¸å¿ƒç®—æ³•å®ç°

### Day 4ä¸Šåˆ (3å°æ—¶)
- âœ… Story 2.2.3: SmartWriteré›†æˆ
- âœ… é›†æˆæµ‹è¯•å’ŒéªŒè¯

### Day 4ä¸‹åˆ (é¢„ç•™)
- Bugä¿®å¤
- æ–‡æ¡£å®Œå–„
- æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰

## âœ… Definition of Done

Epic 2å®Œæˆçš„æ ‡å‡†ï¼š

- [ ] æ‰€æœ‰4ä¸ªStoryçš„éªŒæ”¶æ ‡å‡†è¾¾æˆ
- [ ] æµ‹è¯•è¦†ç›–ç‡>90%
- [ ] PHPé¡¹ç›®éªŒè¯ï¼šè¦†ç›–ç‡26%â†’80%+
- [ ] å›å½’æµ‹è¯•ï¼šç°æœ‰41ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¤„ç†æ—¶é—´å¢åŠ <30%
- [ ] å‘åå…¼å®¹ï¼šenabled=falseæ—¶è¡Œä¸ºä¸å˜
- [ ] æ–‡æ¡£æ›´æ–°ï¼š
  - [ ] README.mdæ·»åŠ è‡ªé€‚åº”ç¬¦å·è¯´æ˜
  - [ ] examples/.codeindex.yamlæ›´æ–°
  - [ ] é…ç½®æœ€ä½³å®è·µæ–‡æ¡£
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] åˆå¹¶åˆ°developåˆ†æ”¯

## ğŸ”® æœªæ¥æ‰©å±•

**å½“å‰EpicèŒƒå›´** (MVP):
- âœ… åŸºäºæ–‡ä»¶å¤§å°çš„è‡ªé€‚åº”
- âœ… é…ç½®åŒ–é˜ˆå€¼å’Œé™åˆ¶
- âœ… ä¸SmartWriteré›†æˆ

**æœªæ¥å¯èƒ½çš„æ‰©å±•**:
- åŸºäºæ–‡ä»¶ç±»å‹çš„è‡ªé€‚åº”ï¼ˆController vs Modelï¼‰
- åŸºäºè¯„åˆ†åˆ†å¸ƒçš„åŠ¨æ€è°ƒæ•´
- äº¤äº’å¼é…ç½®ç”Ÿæˆå·¥å…·
- ç»Ÿè®¡åˆ†æå’Œé…ç½®æ¨è
- æ¸è¿›å¼æ˜¾ç¤ºï¼ˆæŠ˜å /å±•å¼€ï¼‰

## ğŸ“ å‚è€ƒæ–‡æ¡£

- [Phase 1 Agile Plan](./phase1-agile-plan.md)
- [PHP Project Validation Report](../evaluation/php-project-validation.md)
- [Symbol Scorer Documentation](../../src/codeindex/symbol_scorer.py)
- [SmartWriter Documentation](../../src/codeindex/smart_writer.py)

---

**æœ€åæ›´æ–°**: 2026-01-26
**çŠ¶æ€**: è§„åˆ’å®Œæˆï¼Œå¾…å¼€å§‹å®æ–½
**ä¸‹ä¸€æ­¥**: å¼€å§‹Story 2.1.1å®ç°
