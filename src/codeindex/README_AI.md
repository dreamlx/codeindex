<!-- Generated by codeindex at 2026-01-19T10:04:53+08:00 -->

# README_AI.md - codeindex

## Purpose

Core implementation of an AI-native code indexing tool that generates `README_AI.md` files for Python codebases. It parses source code, extracts symbols and structure, then uses external AI CLI tools to generate human-readable summaries.

## Architecture

The module follows a pipeline pattern:

```
Directory → Scanner → Parser → Writer/Invoker → README_AI.md
```

## Key Components

### Entry Point
- **`cli.py`** - Click-based CLI with commands: `scan`, `init`, `status`, `list-dirs`, `index`, `affected`

### Pipeline Stages
- **`scanner.py`** - Directory traversal with glob-based include/exclude filtering. Returns `ScanResult` with files and subdirectories.
- **`parser.py`** - Tree-sitter based Python parser. Extracts `Symbol` (classes, functions, methods with signatures/docstrings) and `Import` statements into `ParseResult`.
- **`writer.py`** - Formats parsed data into LLM prompts and writes output. Provides `generate_fallback_readme()` for AI-free mode.
- **`invoker.py`** - Executes external AI CLI commands via subprocess. Supports both argument and stdin prompt passing. Includes `clean_ai_output()` and `validate_markdown_output()` for AI response validation.
- **`incremental.py`** - Git-based change analysis for smart incremental updates. Analyzes commit diffs to determine which directories need README_AI.md regeneration based on configurable line-count thresholds.

### Configuration
- **`config.py`** - Loads `.codeindex.yaml` with AI command template, glob patterns, output settings, and incremental update configuration. Default include patterns: `src/`, `lib/`, `tests/`, `examples/`. Excludes common non-code directories (`__pycache__`, `node_modules`, `.git`, etc.).
  - `IncrementalConfig` - Configuration for incremental updates with thresholds:
    - `skip_lines` (default: 5) - Changes below this are skipped
    - `current_only` (default: 50) - Small changes update current dir only
    - `suggest_full` (default: 200) - Large changes suggest full update

## Consumes (Dependencies)

| External | Purpose |
|----------|---------|
| `tree-sitter`, `tree-sitter-python` | AST parsing |
| `click` | CLI framework |
| `rich` | Terminal output formatting |
| `pyyaml` | Config file parsing |
| `tomllib`/`tomli` | pyproject.toml parsing (for `index` command) |

## Provides (Exports)

| Export | Consumer |
|--------|----------|
| CLI commands (`scan`, `init`, `status`, `list-dirs`, `index`, `affected`) | End users |
| `parse_file()`, `ParseResult`, `Symbol` | Internal pipeline |
| `scan_directory()`, `find_all_directories()` | Internal pipeline |
| `invoke_ai_cli()`, `format_prompt()` | Internal pipeline |
| `clean_ai_output()`, `validate_markdown_output()` | Internal pipeline |
| `write_readme()`, `generate_fallback_readme()` | Internal pipeline |
| `Config`, `IncrementalConfig` | Internal configuration |
| `analyze_changes()`, `get_dirs_to_update()`, `should_update_project_index()` | Incremental update analysis |
| `UpdateLevel`, `ChangeAnalysis`, `FileChange` | Incremental update data types |

## Incremental Update System

The `incremental.py` module provides smart change detection:

### Update Levels
- **`SKIP`** - Changes too small (below `skip_lines` threshold)
- **`CURRENT`** - Update current directory only (small changes)
- **`AFFECTED`** - Update all affected directories (medium changes)
- **`FULL`** - Suggest full project update (large changes)

### Key Functions
- `get_changed_files(since, until)` - Extracts file changes with line counts from git diff
- `filter_code_files(changes, languages)` - Filters to supported language extensions
- `analyze_changes(config, since, until)` - Returns `ChangeAnalysis` with update recommendation
- `get_dirs_to_update(analysis, config)` - Returns filtered list of directories to update
- `should_update_project_index(analysis, config)` - Determines if PROJECT_INDEX.md needs update

### Data Types
- `FileChange` - Represents a changed file with path, additions, deletions
- `ChangeAnalysis` - Analysis result containing files, totals, affected directories, level, and message

## Data Flow Example

```python
# 1. Load config
config = Config.load()

# 2. Scan directory
scan_result = scan_directory(path, config)

# 3. Parse each file
parse_results = [parse_file(f) for f in scan_result.files]

# 4. Format prompt
prompt = format_prompt(path, files_info, symbols_info, imports_info)

# 5. Invoke AI or fallback
result = invoke_ai_cli(config.ai_command, prompt)
# Clean and validate AI output
cleaned = clean_ai_output(result.output)
if not validate_markdown_output(cleaned):
    # Fallback if validation fails
    generate_fallback_readme(path, parse_results)

# 6. Write output
write_readme(path, cleaned)
```

## CLI Commands

| Command | Description |
|---------|-------------|
| `scan <path>` | Scan directory and generate README_AI.md |
| `init` | Create .codeindex.yaml configuration |
| `status` | Show indexing coverage for the project |
| `list-dirs` | List all indexable directories |
| `index` | Generate PROJECT_INDEX.md - lightweight project overview |
| `affected` | Analyze git changes and show affected directories needing updates |

### Command Options

- **`scan`**: `--dry-run`, `--fallback`, `--quiet`, `--timeout`
- **`init`**: `--force` to overwrite existing config
- **`status`**: `--root` to specify project root
- **`list-dirs`**: `--root` to specify project root
- **`index`**: `--root`, `--output` for custom output filename
- **`affected`**: `--since`, `--until` for commit range, `--json` for scripting output
